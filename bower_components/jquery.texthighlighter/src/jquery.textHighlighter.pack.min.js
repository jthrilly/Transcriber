/*
 jQuery Text Highlighter
 Copyright (C) 2011 - 2013 by mirz

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
*/
(function(a,y,v,u){var s;function t(g,d){this.context=g;this.$context=a(g);this.options=a.extend({},a[w.name].defaults,d);this.init()}s=1;var w={name:"textHighlighter"};t.prototype={init:function(){this.$context.addClass(this.options.contextClass);this.bindEvents()},destroy:function(){this.unbindEvents();this.$context.removeClass(this.options.contextClass);this.$context.removeData(w.name)},bindEvents:function(){this.$context.bind("mouseup",{self:this},this.highlightHandler)},unbindEvents:function(){this.$context.unbind("mouseup",
this.highlightHandler)},highlightHandler:function(a){a.data.self.doHighlight()},doHighlight:function(){var g=this.getCurrentRange();if(g&&!g.collapsed){var d=g.toString();if(!0==this.options.onBeforeHighlight(g)){var f=a.textHighlighter.createWrapper(this.options),g=this.highlightRange(g,f),g=this.normalizeHighlights(g);this.options.onAfterHighlight(g,d)}this.removeAllRanges()}},getCurrentRange:function(){var a=this.getCurrentSelection(),d;0<a.rangeCount&&(d=a.getRangeAt(0));return d},removeAllRanges:function(){this.getCurrentSelection().removeAllRanges()},
getCurrentSelection:function(){var g=this.getCurrentWindow(),d;g.getSelection?d=g.getSelection():a("iframe").length?a("iframe",top.document).each(function(){if(this.contentWindow===g)return d=rangy.getIframeSelection(this),!1}):d=rangy.getSelection();return d},getCurrentWindow:function(){var a=this.getCurrentDocument();return a.defaultView?a.defaultView:a.parentWindow},getCurrentDocument:function(){return this.context.ownerDocument?this.context.ownerDocument:this.context},highlightRange:function(g,
d){if(!g.collapsed){var f="SCRIPT STYLE SELECT BUTTON OBJECT APPLET".split(" "),e=g.startContainer,n=g.endContainer,r=g.commonAncestorContainer,l=!0;if(0==g.endOffset){for(;!n.previousSibling&&n.parentNode!=r;)n=n.parentNode;n=n.previousSibling}else 3==n.nodeType?g.endOffset<n.nodeValue.length&&n.splitText(g.endOffset):0<g.endOffset&&(n=n.childNodes.item(g.endOffset-1));3==e.nodeType?g.startOffset==e.nodeValue.length?l=!1:0<g.startOffset&&(e=e.splitText(g.startOffset),n==e.previousSibling&&(n=e)):
e=g.startOffset<e.childNodes.length?e.childNodes.item(g.startOffset):e.nextSibling;var r=!1,p=[];do{if(l&&3==e.nodeType){if(/\S/.test(e.nodeValue)){var l=d.clone(!0).get(0),c=e.parentNode;if(a.contains(this.context,c)||c===this.context)l=a(e).wrap(l).parent().get(0),p.push(l)}l=!1}e!=n||n.hasChildNodes()&&l||(r=!0);-1!=a.inArray(e.tagName,f)&&(l=!1);l&&e.hasChildNodes()?e=e.firstChild:null!=e.nextSibling?(e=e.nextSibling,l=!0):(e=e.parentNode,l=!1)}while(!r);return p}},normalizeHighlights:function(g){this.flattenNestedHighlights(g);
this.mergeSiblingHighlights(g);return a.map(g,function(a){return"undefined"!=typeof a.parentElement?null!=a.parentElement?a:null:null!=a.parentNode?a:null})},flattenNestedHighlights:function(g){var d=this;a.each(g,function(f){var e=a(this),n=e.parent(),r=n.prev(),l=n.next();d.isHighlight(n)&&(n.css("background-color")!=e.css("background-color")?(d.isHighlight(r)&&(!e.get(0).previousSibling&&r.css("background-color")!=n.css("background-color")&&r.css("background-color")==e.css("background-color"))&&
e.insertAfter(r),d.isHighlight(l)&&(!e.get(0).nextSibling&&l.css("background-color")!=n.css("background-color")&&l.css("background-color")==e.css("background-color"))&&e.insertBefore(l),n.is(":empty")&&n.remove()):(e=v.createTextNode(n.text()),n.empty(),n.append(e),a(g[f]).remove()))})},mergeSiblingHighlights:function(g){function d(d,n){return n&&n.nodeType==s&&a(d).css("background-color")==a(n).css("background-color")&&a(n).hasClass(f.options.highlightedClass)?!0:!1}var f=this;a.each(g,function(){var e=
this.previousSibling,f=this.nextSibling;if(d(this,e)){var g=a(e).text()+a(this).text();a(this).text(g);a(e).remove()}d(this,f)&&(g=a(this).text()+a(f).text(),a(this).text(g),a(f).remove())})},setColor:function(a){this.options.color=a},getColor:function(){return this.options.color},removeHighlights:function(g){var d=this;this.getAllHighlights(g!==u?g:this.context,!0).each(function(){if(!0==d.options.onRemoveHighlight(this)){var f=a(this).contents().unwrap().get(0),e=f.previousSibling,n=f.nextSibling;
e&&3==e.nodeType&&(f.nodeValue=e.nodeValue+f.nodeValue,e.parentNode.removeChild(e));n&&3==n.nodeType&&(f.nodeValue+=n.nodeValue,n.parentNode.removeChild(n))}})},getAllHighlights:function(g,d){var f="."+this.options.highlightedClass,f=a(g).find(f);!0==d&&a(g).hasClass(this.options.highlightedClass)&&(f=f.add(g));return f},isHighlight:function(a){return a.hasClass(this.options.highlightedClass)},serializeHighlights:function(){var g=this.getAllHighlights(this.context),d=this.context,f=[];g.each(function(e,
n){var g=0,l=n.firstChild.length,p=n,c=[];do{var q=a.inArray(p,p.parentNode.childNodes);c.unshift(q);p=p.parentNode}while(p!==d);p=a(n).clone().empty().get(0).outerHTML;n.previousSibling&&3===n.previousSibling.nodeType&&(g=n.previousSibling.length);f.push([p,a(n).text(),c.join(":"),g,l])});return JSON.stringify(f)},deserializeHighlights:function(g){try{var d=JSON.parse(g)}catch(f){throw"Can't parse serialized highlights: "+f;}var e=[],n=this;a.each(d,function(d,f){try{for(var g=f[0],c=f[2].split(":"),
q=f[3],D=f[4],x=c.pop(),s=null,H=n.context;(s=c.shift())!==u;)H=H.childNodes[s];H.childNodes[x-1]&&3===H.childNodes[x-1].nodeType&&(x-=1);var B=H.childNodes[x].splitText(q);B.splitText(D);B.nextSibling&&""==B.nextSibling.nodeValue&&B.parentNode.removeChild(B.nextSibling);B.previousSibling&&""==B.previousSibling.nodeValue&&B.parentNode.removeChild(B.previousSibling);var G=a(B).wrap(g).parent().get(0);e.push(G)}catch(t){return console&&console.warn&&console.warn("Can't deserialize "+d+"-th descriptor. Cause: "+
t),!0}});return e}};a.fn.getHighlighter=function(){return this.data(w.name)};a.fn[w.name]=function(g){return this.each(function(){a.data(this,w.name)||a.data(this,w.name,new t(this,g))})};a.textHighlighter={createWrapper:function(g){return a("<span></span>").css("backgroundColor",g.color).addClass(g.highlightedClass)},defaults:{color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}}})(jQuery,
window,document);window.rangy=function(){function a(c,a){var q=typeof c[a];return"function"==q||!("object"!=q||!c[a])||"unknown"==q}function y(c,a){return!("object"!=typeof c[a]||!c[a])}function v(c,a){return"undefined"!=typeof c[a]}function u(c){return function(a,q){for(var d=q.length;d--;)if(!c(a,q[d]))return!1;return!0}}function s(c){return c&&r(c,n)&&p(c,e)}function t(a){window.alert("Rangy not supported in your browser. Reason: "+a);c.initialized=!0;c.supported=!1}function w(){if(!c.initialized){var e,n=!1,g=
!1;a(document,"createRange")&&(e=document.createRange(),r(e,f)&&p(e,d)&&(n=!0),e.detach());(e=y(document,"body")?document.body:document.getElementsByTagName("body")[0])&&a(e,"createTextRange")&&(e=e.createTextRange(),s(e)&&(g=!0));n||g||t("Neither Range nor TextRange are implemented");c.initialized=!0;c.features={implementsDomRange:n,implementsTextRange:g};n=D.concat(q);g=0;for(e=n.length;g<e;++g)try{n[g](c)}catch(l){y(window,"console")&&a(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",
l)}}}function g(c){this.name=c;this.supported=this.initialized=!1}var d="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer START_TO_START START_TO_END END_TO_START END_TO_END".split(" "),f="setStart setStartBefore setStartAfter setEnd setEndBefore setEndAfter collapse selectNode selectNodeContents compareBoundaryPoints deleteContents extractContents cloneContents insertNode surroundContents cloneRange toString detach".split(" "),e="boundingHeight boundingLeft boundingTop boundingWidth htmlText text".split(" "),
n="collapse compareEndPoints duplicate getBookmark moveToBookmark moveToElementText parentElement pasteHTML select setEndPoint getBoundingClientRect".split(" "),r=u(a),l=u(y),p=u(v),c={version:"1.2.3",initialized:!1,supported:!0,util:{isHostMethod:a,isHostObject:y,isHostProperty:v,areHostMethods:r,areHostObjects:l,areHostProperties:p,isTextRange:s},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};c.fail=t;c.warn=function(a){a="Rangy warning: "+a;c.config.alertOnWarn?window.alert(a):
"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log&&window.console.log(a)};({}).hasOwnProperty?c.util.extend=function(c,a){for(var q in a)a.hasOwnProperty(q)&&(c[q]=a[q])}:t("hasOwnProperty not supported");var q=[],D=[];c.init=w;c.addInitListener=function(a){c.initialized?a(c):q.push(a)};var x=[];c.addCreateMissingNativeApiListener=function(c){x.push(c)};c.createMissingNativeApi=function(c){c=c||window;w();for(var a=0,q=x.length;a<q;++a)x[a](c)};g.prototype.fail=function(c){this.initialized=
!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+c);};g.prototype.warn=function(a){c.warn("Module "+this.name+": "+a)};g.prototype.createError=function(c){return Error("Error in Rangy "+this.name+" module: "+c)};c.createModule=function(a,q){var d=new g(a);c.modules[a]=d;D.push(function(c){q(c,d);d.initialized=!0;d.supported=!0})};c.requireModules=function(a){for(var q=0,d=a.length,e,f;q<d;++q){f=a[q];e=c.modules[f];if(!(e&&e instanceof g))throw Error("Module '"+f+"' not found");
if(!e.supported)throw Error("Module '"+f+"' not supported");}};var F=!1,l=function(){F||(F=!0,c.initialized||w())};if("undefined"==typeof window)t("No window found");else if("undefined"==typeof document)t("No document found");else return a(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",l,!1),a(window,"addEventListener")?window.addEventListener("load",l,!1):a(window,"attachEvent")?window.attachEvent("onload",l):t("Window does not have required addEventListener or attachEvent method"),
c}();
rangy.createModule("DomUtil",function(a,y){function v(c){for(var a=0;c=c.previousSibling;)a++;return a}function u(c,a){var d=[],e;for(e=c;e;e=e.parentNode)d.push(e);for(e=a;e;e=e.parentNode)if(p(d,e))return e;return null}function s(c,a,d){for(d=d?c:c.parentNode;d;){c=d.parentNode;if(c===a)return d;d=c}return null}function t(c){c=c.nodeType;return 3==c||4==c||8==c}function w(c,a){var d=a.nextSibling,e=a.parentNode;d?e.insertBefore(c,d):e.appendChild(c);return c}function g(c){if(9==c.nodeType)return c;if("undefined"!=
typeof c.ownerDocument)return c.ownerDocument;if("undefined"!=typeof c.document)return c.document;if(c.parentNode)return g(c.parentNode);throw Error("getDocument: no document found for node");}function d(c){return c?t(c)?'"'+c.data+'"':1==c.nodeType?"<"+c.nodeName+(c.id?' id="'+c.id+'"':"")+">["+c.childNodes.length+"]":c.nodeName:"[No node]"}function f(c){this._next=this.root=c}function e(c,a){this.node=c;this.offset=a}function n(c){this.code=this[c];this.codeName=c;this.message="DOMException: "+
this.codeName}var r=a.util;r.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||y.fail("document missing a Node creation method");r.isHostMethod(document,"getElementsByTagName")||y.fail("document missing getElementsByTagName method");var l=document.createElement("div");r.areHostMethods(l,["insertBefore","appendChild","cloneNode"])||y.fail("Incomplete Element implementation");r.isHostProperty(l,"innerHTML")||y.fail("Element is missing innerHTML property");l=document.createTextNode("test");
r.areHostMethods(l,["splitText","deleteData","insertData","appendData","cloneNode"])||y.fail("Incomplete Text Node implementation");var p=function(c,a){for(var d=c.length;d--;)if(c[d]===a)return!0;return!1};f.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var c=this._current=this._next,a;if(this._current){if(!(a=c.firstChild))for(a=null;c!==this.root&&!(a=c.nextSibling);)c=c.parentNode;this._next=a}return this._current},detach:function(){this._current=this._next=this.root=
null}};e.prototype={equals:function(c){return this.node===c.node&this.offset==c.offset},inspect:function(){return"[DomPosition("+d(this.node)+":"+this.offset+")]"}};n.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};n.prototype.toString=function(){return this.message};a.dom={arrayContains:p,isHtmlNamespace:function(c){var a;return"undefined"==typeof c.namespaceURI||null===(a=c.namespaceURI)||
"http://www.w3.org/1999/xhtml"==a},parentElement:function(c){c=c.parentNode;return 1==c.nodeType?c:null},getNodeIndex:v,getNodeLength:function(c){var a;return t(c)?c.length:(a=c.childNodes)?a.length:0},getCommonAncestor:u,isAncestorOf:function(c,a,d){for(a=d?a:a.parentNode;a;){if(a===c)return!0;a=a.parentNode}return!1},getClosestAncestorIn:s,isCharacterDataNode:t,insertAfter:w,splitDataNode:function(c,a){var d=c.cloneNode(!1);d.deleteData(0,a);c.deleteData(a,c.length-a);w(d,c);return d},getDocument:g,
getWindow:function(c){c=g(c);if("undefined"!=typeof c.defaultView)return c.defaultView;if("undefined"!=typeof c.parentWindow)return c.parentWindow;throw Error("Cannot get a window object for node");},getIframeWindow:function(c){if("undefined"!=typeof c.contentWindow)return c.contentWindow;if("undefined"!=typeof c.contentDocument)return c.contentDocument.defaultView;throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(c){if("undefined"!=typeof c.contentDocument)return c.contentDocument;
if("undefined"!=typeof c.contentWindow)return c.contentWindow.document;throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(c){return r.isHostObject(c,"body")?c.body:c.getElementsByTagName("body")[0]},getRootContainer:function(c){for(var a;a=c.parentNode;)c=a;return c},comparePoints:function(c,a,d,e){var f;if(c==d)return a===e?0:a<e?-1:1;if(f=s(d,c,!0))return a<=v(f)?-1:1;if(f=s(c,d,!0))return v(f)<e?-1:1;a=u(c,d);c=c===a?a:s(c,a,!0);d=d===a?a:s(d,a,!0);if(c===
d)throw Error("comparePoints got to case 4 and childA and childB are the same!");for(a=a.firstChild;a;){if(a===c)return-1;if(a===d)return 1;a=a.nextSibling}throw Error("Should not be here!");},inspectNode:d,fragmentFromNodeChildren:function(a){for(var d=g(a).createDocumentFragment(),e;e=a.firstChild;)d.appendChild(e);return d},createIterator:function(a){return new f(a)},DomPosition:e};a.DOMException=n});
rangy.createModule("DomRange",function(a){function y(h,b){return 3!=h.nodeType&&(k.isAncestorOf(h,b.startContainer,!0)||k.isAncestorOf(h,b.endContainer,!0))}function v(h){return k.getDocument(h.startContainer)}function u(h,b,a){if(b=h._listeners[b])for(var c=0,d=b.length;c<d;++c)b[c].call(h,{target:h,args:a})}function s(h){return new L(h.parentNode,k.getNodeIndex(h))}function t(h){return new L(h.parentNode,k.getNodeIndex(h)+1)}function w(h,b,a){var c=11==h.nodeType?h.firstChild:h;k.isCharacterDataNode(b)?
a==b.length?k.insertAfter(h,b):b.parentNode.insertBefore(h,0==a?b:k.splitDataNode(b,a)):a>=b.childNodes.length?b.appendChild(h):b.insertBefore(h,b.childNodes[a]);return c}function g(h){for(var b,a,c=v(h.range).createDocumentFragment();a=h.next();){b=h.isPartiallySelectedSubtree();a=a.cloneNode(!b);b&&(b=h.getSubtreeIterator(),a.appendChild(g(b)),b.detach(!0));if(10==a.nodeType)throw new E("HIERARCHY_REQUEST_ERR");c.appendChild(a)}return c}function d(h,b,a){var c,m;for(a=a||{stop:!1};c=h.next();)if(h.isPartiallySelectedSubtree())if(!1===
b(c)){a.stop=!0;break}else{if(c=h.getSubtreeIterator(),d(c,b,a),c.detach(!0),a.stop)break}else for(c=k.createIterator(c);m=c.next();)if(!1===b(m)){a.stop=!0;return}}function f(h){for(var b;h.next();)h.isPartiallySelectedSubtree()?(b=h.getSubtreeIterator(),f(b),b.detach(!0)):h.remove()}function e(h){for(var b,a=v(h.range).createDocumentFragment(),c;b=h.next();){h.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),c=h.getSubtreeIterator(),b.appendChild(e(c)),c.detach(!0)):h.remove();if(10==b.nodeType)throw new E("HIERARCHY_REQUEST_ERR");
a.appendChild(b)}return a}function n(h,b,a){var c=!(!b||!b.length),m,e=!!a;c&&(m=RegExp("^("+b.join("|")+")$"));var f=[];d(new l(h,!1),function(h){c&&!m.test(h.nodeType)||e&&!a(h)||f.push(h)});return f}function r(h){return"["+("undefined"==typeof h.getName?"Range":h.getName())+"("+k.inspectNode(h.startContainer)+":"+h.startOffset+", "+k.inspectNode(h.endContainer)+":"+h.endOffset+")]"}function l(h,b){this.range=h;this.clonePartiallySelectedTextNodes=b;if(!h.collapsed){this.sc=h.startContainer;this.so=
h.startOffset;this.ec=h.endContainer;this.eo=h.endOffset;var a=h.commonAncestorContainer;this.sc===this.ec&&k.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==a||k.isCharacterDataNode(this.sc)?k.getClosestAncestorIn(this.sc,a,!0):this.sc.childNodes[this.so],this._last=this.ec!==a||k.isCharacterDataNode(this.ec)?k.getClosestAncestorIn(this.ec,a,!0):this.ec.childNodes[this.eo-1])}}function p(h){this.code=this[h];
this.codeName=h;this.message="RangeException: "+this.codeName}function c(h,b,a){this.nodes=n(h,b,a);this._next=this.nodes[0];this._position=0}function q(h){return function(b,a){for(var c,m=a?b:b.parentNode;m;){c=m.nodeType;if(k.arrayContains(h,c))return m;m=m.parentNode}return null}}function D(h,b){if(ea(h,b))throw new p("INVALID_NODE_TYPE_ERR");}function x(h){if(!h.startContainer)throw new E("INVALID_STATE_ERR");}function F(h,b){if(!k.arrayContains(b,h.nodeType))throw new p("INVALID_NODE_TYPE_ERR");
}function H(h,b){if(0>b||b>(k.isCharacterDataNode(h)?h.length:h.childNodes.length))throw new E("INDEX_SIZE_ERR");}function B(b,a){if(U(b,!0)!==U(a,!0))throw new E("WRONG_DOCUMENT_ERR");}function G(b){if(fa(b,!0))throw new E("NO_MODIFICATION_ALLOWED_ERR");}function C(b,a){if(!b)throw new E(a);}function J(b){return!!b.startContainer&&!!b.endContainer&&!(!k.arrayContains(O,b.startContainer.nodeType)&&!U(b.startContainer,!0))&&!(!k.arrayContains(O,b.endContainer.nodeType)&&!U(b.endContainer,!0))&&b.startOffset<=
(k.isCharacterDataNode(b.startContainer)?b.startContainer.length:b.startContainer.childNodes.length)&&b.endOffset<=(k.isCharacterDataNode(b.endContainer)?b.endContainer.length:b.endContainer.childNodes.length)}function z(b){x(b);if(!J(b))throw Error("Range error: Range is no longer valid after DOM mutation ("+b.inspect()+")");}function P(){}function K(b){b.START_TO_START=V;b.START_TO_END=Z;b.END_TO_END=ga;b.END_TO_START=$;b.NODE_BEFORE=aa;b.NODE_AFTER=ba;b.NODE_BEFORE_AND_AFTER=ca;b.NODE_INSIDE=W}
function I(b){K(b);K(b.prototype)}function Q(b,a){return function(){z(this);var c=this.startContainer,m=this.startOffset,e=this.commonAncestorContainer,f=new l(this,!0);c!==e&&(c=k.getClosestAncestorIn(c,e,!0),m=t(c),c=m.node,m=m.offset);d(f,G);f.reset();e=b(f);f.detach();a(this,c,m,c,m);return e}}function S(b,c,d){function q(b,a){return function(h){x(this);F(h,M);F(m(h),O);h=(b?s:t)(h);(a?g:n)(this,h.node,h.offset)}}function g(b,a,h){var d=b.endContainer,e=b.endOffset;if(a!==b.startContainer||h!==
b.startOffset){if(m(a)!=m(d)||1==k.comparePoints(a,h,d,e))d=a,e=h;c(b,a,h,d,e)}}function n(b,a,h){var d=b.startContainer,e=b.startOffset;if(a!==b.endContainer||h!==b.endOffset){if(m(a)!=m(d)||-1==k.comparePoints(a,h,d,e))d=a,e=h;c(b,d,e,a,h)}}b.prototype=new P;a.util.extend(b.prototype,{setStart:function(b,a){x(this);D(b,!0);H(b,a);g(this,b,a)},setEnd:function(b,a){x(this);D(b,!0);H(b,a);n(this,b,a)},setStartBefore:q(!0,!0),setStartAfter:q(!1,!0),setEndBefore:q(!0,!1),setEndAfter:q(!1,!1),collapse:function(b){z(this);
b?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(b){x(this);D(b,!0);c(this,b,0,b,k.getNodeLength(b))},selectNode:function(b){x(this);D(b,!1);F(b,M);var a=s(b);b=t(b);c(this,a.node,a.offset,b.node,b.offset)},extractContents:Q(e,c),deleteContents:Q(f,c),canSurroundContents:function(){z(this);G(this.startContainer);G(this.endContainer);var b=new l(this,!0),a=b._first&&
y(b._first,this)||b._last&&y(b._last,this);b.detach();return!a},detach:function(){d(this)},splitBoundaries:function(){z(this);var b=this.startContainer,a=this.startOffset,h=this.endContainer,m=this.endOffset,d=b===h;k.isCharacterDataNode(h)&&0<m&&m<h.length&&k.splitDataNode(h,m);k.isCharacterDataNode(b)&&(0<a&&a<b.length)&&(b=k.splitDataNode(b,a),d?(m-=a,h=b):h==b.parentNode&&m>=k.getNodeIndex(b)&&m++,a=0);c(this,b,a,h,m)},normalizeBoundaries:function(){z(this);var b=this.startContainer,a=this.startOffset,
h=this.endContainer,m=this.endOffset,d=function(b){var a=b.nextSibling;a&&a.nodeType==b.nodeType&&(h=b,m=b.length,b.appendData(a.data),a.parentNode.removeChild(a))},e=function(c){var d=c.previousSibling;if(d&&d.nodeType==c.nodeType){b=c;var e=c.length;a=d.length;c.insertData(0,d.data);d.parentNode.removeChild(d);b==h?(m+=a,h=b):h==c.parentNode&&(d=k.getNodeIndex(c),m==d?(h=c,m=e):m>d&&m--)}},f=!0;k.isCharacterDataNode(h)?h.length==m&&d(h):(0<m&&(f=h.childNodes[m-1])&&k.isCharacterDataNode(f)&&d(f),
f=!this.collapsed);f?k.isCharacterDataNode(b)?0==a&&e(b):a<b.childNodes.length&&(d=b.childNodes[a])&&k.isCharacterDataNode(d)&&e(d):(b=h,a=m);c(this,b,a,h,m)},collapseToPoint:function(b,a){x(this);D(b,!0);H(b,a);b===this.startContainer&&a===this.startOffset&&b===this.endContainer&&a===this.endOffset||c(this,b,a,b,a)}});I(b)}function R(b){b.collapsed=b.startContainer===b.endContainer&&b.startOffset===b.endOffset;b.commonAncestorContainer=b.collapsed?b.startContainer:k.getCommonAncestor(b.startContainer,
b.endContainer)}function T(b,a,c,m,d){var e=b.startContainer!==a||b.startOffset!==c,f=b.endContainer!==m||b.endOffset!==d;b.startContainer=a;b.startOffset=c;b.endContainer=m;b.endOffset=d;R(b);u(b,"boundarychange",{startMoved:e,endMoved:f})}function A(b){this.startContainer=b;this.startOffset=0;this.endContainer=b;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};R(this)}a.requireModules(["DomUtil"]);var k=a.dom,L=k.DomPosition,E=a.DOMException;l.prototype={_current:null,_next:null,_first:null,
_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var b=this._current=this._next;b&&(this._next=b!==this._last?b.nextSibling:null,k.isCharacterDataNode(b)&&this.clonePartiallySelectedTextNodes&&(b===this.ec&&(b=b.cloneNode(!0)).deleteData(this.eo,b.length-this.eo),this._current===this.sc&&(b=b.cloneNode(!0)).deleteData(0,this.so)));return b},remove:function(){var b=this._current,a,c;!k.isCharacterDataNode(b)||
b!==this.sc&&b!==this.ec?b.parentNode&&b.parentNode.removeChild(b):(a=b===this.sc?this.so:0,c=b===this.ec?this.eo:b.length,a!=c&&b.deleteData(a,c-a))},isPartiallySelectedSubtree:function(){return y(this._current,this.range)},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode)b=this.range.cloneRange(),b.collapse();else{b=new A(v(this.range));var a=this._current,c=a,m=0,d=a,e=k.getNodeLength(a);k.isAncestorOf(a,this.sc,!0)&&(c=this.sc,m=this.so);k.isAncestorOf(a,this.ec,!0)&&(d=this.ec,
e=this.eo);T(b,c,m,d,e)}return new l(b,this.clonePartiallySelectedTextNodes)},detach:function(b){b&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};p.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};p.prototype.toString=function(){return this.message};c.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},
detach:function(){this._current=this._next=this.nodes=null}};var M=[1,3,4,5,7,8,10],O=[2,9,11],N=[1,3,4,5,7,8,10,11],b=[1,3,4,5,7,8],m=k.getRootContainer,U=q([9,11]),fa=q([5,6,10,12]),ea=q([6,10,12]),da=document.createElement("style"),X=!1;try{da.innerHTML="<b>x</b>",X=3==da.firstChild.nodeType}catch(ha){}a.features.htmlParsingConforms=X;var Y="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),V=0,Z=1,ga=2,$=3,aa=0,ba=1,ca=2,W=3;P.prototype={attachListener:function(b,
a){this._listeners[b].push(a)},compareBoundaryPoints:function(b,a){z(this);B(this.startContainer,a.startContainer);var c=b==$||b==V?"start":"end",m=b==Z||b==V?"start":"end";return k.comparePoints(this[c+"Container"],this[c+"Offset"],a[m+"Container"],a[m+"Offset"])},insertNode:function(b){z(this);F(b,N);G(this.startContainer);if(k.isAncestorOf(b,this.startContainer,!0))throw new E("HIERARCHY_REQUEST_ERR");this.setStartBefore(w(b,this.startContainer,this.startOffset))},cloneContents:function(){z(this);
var b,a;if(this.collapsed)return v(this).createDocumentFragment();if(this.startContainer===this.endContainer&&k.isCharacterDataNode(this.startContainer))return b=this.startContainer.cloneNode(!0),b.data=b.data.slice(this.startOffset,this.endOffset),a=v(this).createDocumentFragment(),a.appendChild(b),a;a=new l(this,!0);b=g(a);a.detach();return b},canSurroundContents:function(){z(this);G(this.startContainer);G(this.endContainer);var b=new l(this,!0),a=b._first&&y(b._first,this)||b._last&&y(b._last,
this);b.detach();return!a},surroundContents:function(a){F(a,b);if(!this.canSurroundContents())throw new p("BAD_BOUNDARYPOINTS_ERR");var c=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);w(a,this.startContainer,this.startOffset);a.appendChild(c);this.selectNode(a)},cloneRange:function(){z(this);for(var b=new A(v(this)),a=Y.length,c;a--;)c=Y[a],b[c]=this[c];return b},toString:function(){z(this);var b=this.startContainer;if(b===this.endContainer&&k.isCharacterDataNode(b))return 3==
b.nodeType||4==b.nodeType?b.data.slice(this.startOffset,this.endOffset):"";var a=[],b=new l(this,!0);d(b,function(b){3!=b.nodeType&&4!=b.nodeType||a.push(b.data)});b.detach();return a.join("")},compareNode:function(b){z(this);var a=b.parentNode,c=k.getNodeIndex(b);if(!a)throw new E("NOT_FOUND_ERR");b=this.comparePoint(a,c);a=this.comparePoint(a,c+1);return 0>b?0<a?ca:aa:0<a?ba:W},comparePoint:function(b,a){z(this);C(b,"HIERARCHY_REQUEST_ERR");B(b,this.startContainer);return 0>k.comparePoints(b,a,
this.startContainer,this.startOffset)?-1:0<k.comparePoints(b,a,this.endContainer,this.endOffset)?1:0},createContextualFragment:X?function(b){var a=this.startContainer,c=k.getDocument(a);if(!a)throw new E("INVALID_STATE_ERR");var m=null;1==a.nodeType?m=a:k.isCharacterDataNode(a)&&(m=k.parentElement(a));m=null===m||"HTML"==m.nodeName&&k.isHtmlNamespace(k.getDocument(m).documentElement)&&k.isHtmlNamespace(m)?c.createElement("body"):m.cloneNode(!1);m.innerHTML=b;return k.fragmentFromNodeChildren(m)}:
function(b){x(this);var a=v(this).createElement("body");a.innerHTML=b;return k.fragmentFromNodeChildren(a)},toHtml:function(){z(this);var b=v(this).createElement("div");b.appendChild(this.cloneContents());return b.innerHTML},intersectsNode:function(b,a){z(this);C(b,"NOT_FOUND_ERR");if(k.getDocument(b)!==v(this))return!1;var c=b.parentNode,m=k.getNodeIndex(b);C(c,"NOT_FOUND_ERR");var d=k.comparePoints(c,m,this.endContainer,this.endOffset),c=k.comparePoints(c,m+1,this.startContainer,this.startOffset);
return a?0>=d&&0<=c:0>d&&0<c},isPointInRange:function(b,a){z(this);C(b,"HIERARCHY_REQUEST_ERR");B(b,this.startContainer);return 0<=k.comparePoints(b,a,this.startContainer,this.startOffset)&&0>=k.comparePoints(b,a,this.endContainer,this.endOffset)},intersectsRange:function(b,a){z(this);if(v(b)!=v(this))throw new E("WRONG_DOCUMENT_ERR");var c=k.comparePoints(this.startContainer,this.startOffset,b.endContainer,b.endOffset),m=k.comparePoints(this.endContainer,this.endOffset,b.startContainer,b.startOffset);
return a?0>=c&&0<=m:0>c&&0<m},intersection:function(b){if(this.intersectsRange(b)){var a=k.comparePoints(this.startContainer,this.startOffset,b.startContainer,b.startOffset),c=k.comparePoints(this.endContainer,this.endOffset,b.endContainer,b.endOffset),m=this.cloneRange();-1==a&&m.setStart(b.startContainer,b.startOffset);1==c&&m.setEnd(b.endContainer,b.endOffset);return m}return null},union:function(b){if(this.intersectsRange(b,!0)){var a=this.cloneRange();-1==k.comparePoints(b.startContainer,b.startOffset,
this.startContainer,this.startOffset)&&a.setStart(b.startContainer,b.startOffset);1==k.comparePoints(b.endContainer,b.endOffset,this.endContainer,this.endOffset)&&a.setEnd(b.endContainer,b.endOffset);return a}throw new p("Ranges do not intersect");},containsNode:function(b,a){return a?this.intersectsNode(b,!1):this.compareNode(b)==W},containsNodeContents:function(b){return 0<=this.comparePoint(b,0)&&0>=this.comparePoint(b,k.getNodeLength(b))},containsRange:function(b){return this.intersection(b).equals(b)},
containsNodeText:function(b){var a=this.cloneRange();a.selectNode(b);var c=a.getNodes([3]);return 0<c.length?(a.setStart(c[0],0),b=c.pop(),a.setEnd(b,b.length),b=this.containsRange(a),a.detach(),b):this.containsNodeContents(b)},createNodeIterator:function(b,a){z(this);return new c(this,b,a)},getNodes:function(b,a){z(this);return n(this,b,a)},getDocument:function(){return v(this)},collapseBefore:function(b){x(this);this.setEndBefore(b);this.collapse(!1)},collapseAfter:function(b){x(this);this.setStartAfter(b);
this.collapse(!0)},getName:function(){return"DomRange"},equals:function(b){return A.rangesEqual(this,b)},isValid:function(){return J(this)},inspect:function(){return r(this)}};S(A,T,function(b){x(b);b.startContainer=b.startOffset=b.endContainer=b.endOffset=null;b.collapsed=b.commonAncestorContainer=null;u(b,"detach",null);b._listeners=null});a.rangePrototype=P.prototype;A.rangeProperties=Y;A.RangeIterator=l;A.copyComparisonConstants=I;A.createPrototypeRange=S;A.inspect=r;A.getRangeDocument=v;A.rangesEqual=
function(b,a){return b.startContainer===a.startContainer&&b.startOffset===a.startOffset&&b.endContainer===a.endContainer&&b.endOffset===a.endOffset};a.DomRange=A;a.RangeException=p});
rangy.createModule("WrappedRange",function(a){function y(a,f,e,g){var r=a.duplicate();r.collapse(e);var l=r.parentElement();s.isAncestorOf(f,l,!0)||(l=f);if(!l.canHaveHTML)return new t(l.parentNode,s.getNodeIndex(l));f=s.getDocument(l).createElement("span");var p,c=e?"StartToStart":"StartToEnd";do l.insertBefore(f,f.previousSibling),r.moveToElementText(f);while(0<(p=r.compareEndPoints(c,a))&&f.previousSibling);c=f.nextSibling;if(-1==p&&c&&s.isCharacterDataNode(c)){r.setEndPoint(e?"EndToStart":"EndToEnd",
a);if(/[\r\n]/.test(c.data))for(l=r.duplicate(),e=l.text.replace(/\r\n/g,"\r").length,e=l.moveStart("character",e);-1==l.compareEndPoints("StartToEnd",l);)e++,l.moveStart("character",1);else e=r.text.length;l=new t(c,e)}else c=(g||!e)&&f.previousSibling,l=(e=(g||e)&&f.nextSibling)&&s.isCharacterDataNode(e)?new t(e,0):c&&s.isCharacterDataNode(c)?new t(c,c.length):new t(l,s.getNodeIndex(f));f.parentNode.removeChild(f);return l}function v(a,f){var e,g,r=a.offset,l=s.getDocument(a.node),p=l.body.createTextRange(),
c=s.isCharacterDataNode(a.node);c?(e=a.node,g=e.parentNode):(e=a.node.childNodes,e=r<e.length?e[r]:null,g=a.node);l=l.createElement("span");l.innerHTML="&#feff;";e?g.insertBefore(l,e):g.appendChild(l);p.moveToElementText(l);p.collapse(!f);g.removeChild(l);if(c)p[f?"moveStart":"moveEnd"]("character",r);return p}a.requireModules(["DomUtil","DomRange"]);var u,s=a.dom,t=s.DomPosition,w=a.DomRange;if(a.features.implementsDomRange&&(!a.features.implementsTextRange||!a.config.preferTextRange))(function(){function d(a){for(var c=
e.length,d;c--;)d=e[c],a[d]=a.nativeRange[d]}var f,e=w.rangeProperties,g,r;u=function(a){if(!a)throw Error("Range must be specified");this.nativeRange=a;d(this)};w.createPrototypeRange(u,function(a,c,d,e,f){var g=a.endContainer!==e||a.endOffset!=f;if(a.startContainer!==c||a.startOffset!=d||g)a.setEnd(e,f),a.setStart(c,d)},function(a){a.nativeRange.detach();a.detached=!0;for(var c=e.length,d;c--;)d=e[c],a[d]=null});f=u.prototype;f.selectNode=function(a){this.nativeRange.selectNode(a);d(this)};f.deleteContents=
function(){this.nativeRange.deleteContents();d(this)};f.extractContents=function(){var a=this.nativeRange.extractContents();d(this);return a};f.cloneContents=function(){return this.nativeRange.cloneContents()};f.surroundContents=function(a){this.nativeRange.surroundContents(a);d(this)};f.collapse=function(a){this.nativeRange.collapse(a);d(this)};f.cloneRange=function(){return new u(this.nativeRange.cloneRange())};f.refresh=function(){d(this)};f.toString=function(){return this.nativeRange.toString()};
var l=document.createTextNode("test");s.getBody(document).appendChild(l);var p=document.createRange();p.setStart(l,0);p.setEnd(l,0);try{p.setStart(l,1),g=!0,f.setStart=function(a,c){this.nativeRange.setStart(a,c);d(this)},f.setEnd=function(a,c){this.nativeRange.setEnd(a,c);d(this)},r=function(a){return function(c){this.nativeRange[a](c);d(this)}}}catch(c){g=!1,f.setStart=function(a,c){try{this.nativeRange.setStart(a,c)}catch(e){this.nativeRange.setEnd(a,c),this.nativeRange.setStart(a,c)}d(this)},
f.setEnd=function(a,c){try{this.nativeRange.setEnd(a,c)}catch(e){this.nativeRange.setStart(a,c),this.nativeRange.setEnd(a,c)}d(this)},r=function(a,c){return function(e){try{this.nativeRange[a](e)}catch(f){this.nativeRange[c](e),this.nativeRange[a](e)}d(this)}}}f.setStartBefore=r("setStartBefore","setEndBefore");f.setStartAfter=r("setStartAfter","setEndAfter");f.setEndBefore=r("setEndBefore","setStartBefore");f.setEndAfter=r("setEndAfter","setStartAfter");p.selectNodeContents(l);f.selectNodeContents=
p.startContainer==l&&p.endContainer==l&&0==p.startOffset&&p.endOffset==l.length?function(a){this.nativeRange.selectNodeContents(a);d(this)}:function(a){this.setStart(a,0);this.setEnd(a,w.getEndOffset(a))};p.selectNodeContents(l);p.setEnd(l,3);g=document.createRange();g.selectNodeContents(l);g.setEnd(l,4);g.setStart(l,2);f.compareBoundaryPoints=-1==p.compareBoundaryPoints(p.START_TO_END,g)&1==p.compareBoundaryPoints(p.END_TO_START,g)?function(a,c){c=c.nativeRange||c;a==c.START_TO_END?a=c.END_TO_START:
a==c.END_TO_START&&(a=c.START_TO_END);return this.nativeRange.compareBoundaryPoints(a,c)}:function(a,c){return this.nativeRange.compareBoundaryPoints(a,c.nativeRange||c)};a.util.isHostMethod(p,"createContextualFragment")&&(f.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)});s.getBody(document).removeChild(l);p.detach();g.detach()})(),a.createNativeRange=function(a){a=a||document;return a.createRange()};else if(a.features.implementsTextRange){u=function(a){this.textRange=
a;this.refresh()};u.prototype=new w(document);u.prototype.refresh=function(){var a,f,e=this.textRange;a=e.parentElement();var g=e.duplicate();g.collapse(!0);f=g.parentElement();g=e.duplicate();g.collapse(!1);e=g.parentElement();f=f==e?f:s.getCommonAncestor(f,e);f=f==a?f:s.getCommonAncestor(a,f);0==this.textRange.compareEndPoints("StartToEnd",this.textRange)?f=a=y(this.textRange,f,!0,!0):(a=y(this.textRange,f,!0,!1),f=y(this.textRange,f,!1,!1));this.setStart(a.node,a.offset);this.setEnd(f.node,f.offset)};
w.copyComparisonConstants(u);var g=function(){return this}();"undefined"==typeof g.Range&&(g.Range=u);a.createNativeRange=function(a){a=a||document;return a.body.createTextRange()}}a.features.implementsTextRange&&(u.rangeToTextRange=function(a){if(a.collapsed)return v(new t(a.startContainer,a.startOffset),!0);var f=v(new t(a.startContainer,a.startOffset),!0),e=v(new t(a.endContainer,a.endOffset),!1);a=s.getDocument(a.startContainer).body.createTextRange();a.setEndPoint("StartToStart",f);a.setEndPoint("EndToEnd",
e);return a});u.prototype.getName=function(){return"WrappedRange"};a.WrappedRange=u;a.createRange=function(d){d=d||document;return new u(a.createNativeRange(d))};a.createRangyRange=function(a){a=a||document;return new w(a)};a.createIframeRange=function(d){return a.createRange(s.getIframeDocument(d))};a.createIframeRangyRange=function(d){return a.createRangyRange(s.getIframeDocument(d))};a.addCreateMissingNativeApiListener(function(d){d=d.document;"undefined"==typeof d.createRange&&(d.createRange=
function(){return a.createRange(this)});d=d=null})});
rangy.createModule("WrappedSelection",function(a,y){function v(b){return(b||window).getSelection()}function u(b){return(b||window).document.selection}function s(b,a,c){var d=c?"end":"start";c=c?"start":"end";b.anchorNode=a[d+"Container"];b.anchorOffset=a[d+"Offset"];b.focusNode=a[c+"Container"];b.focusOffset=a[c+"Offset"]}function t(b){b.anchorNode=b.focusNode=null;b.anchorOffset=b.focusOffset=0;b.rangeCount=0;b.isCollapsed=!0;b._ranges.length=0}function w(b){var m;b instanceof D?(m=b._selectionNativeRange,
m||(m=a.createNativeRange(c.getDocument(b.startContainer)),m.setEnd(b.endContainer,b.endOffset),m.setStart(b.startContainer,b.startOffset),b._selectionNativeRange=m,b.attachListener("detach",function(){this._selectionNativeRange=null}))):b instanceof x?m=b.nativeRange:a.features.implementsDomRange&&b instanceof c.getWindow(b.startContainer).Range&&(m=b);return m}function g(b){var a=b.getNodes(),d;a:if(a.length&&1==a[0].nodeType){d=1;for(var e=a.length;d<e;++d)if(!c.isAncestorOf(a[0],a[d])){d=!1;break a}d=
!0}else d=!1;if(!d)throw Error("getSingleElementFromRange: range "+b.inspect()+" did not consist of a single element");return a[0]}function d(b,a){var c=new x(a);b._ranges=[c];s(b,c,!1);b.rangeCount=1;b.isCollapsed=c.collapsed}function f(b){b._ranges.length=0;if("None"==b.docSelection.type)t(b);else{var m=b.docSelection.createRange();if(m&&"undefined"!=typeof m.text)d(b,m);else{b.rangeCount=m.length;for(var e,f=c.getDocument(m.item(0)),g=0;g<b.rangeCount;++g)e=a.createRange(f),e.selectNode(m.item(g)),
b._ranges.push(e);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed;s(b,b._ranges[b.rangeCount-1],!1)}}}function e(b,a){for(var d=b.docSelection.createRange(),e=g(a),k=c.getDocument(d.item(0)),k=c.getBody(k).createControlRange(),l=0,n=d.length;l<n;++l)k.add(d.item(l));try{k.add(e)}catch(p){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}k.select();f(b)}function n(b,a,c){this.nativeSelection=b;this.docSelection=a;this._ranges=
[];this.win=c;this.refresh()}function r(b,a){for(var d=c.getDocument(a[0].startContainer),d=c.getBody(d).createControlRange(),e=0,k;e<rangeCount;++e){k=g(a[e]);try{d.add(k)}catch(l){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}d.select();f(b)}function l(b,a){if(b.anchorNode&&c.getDocument(b.anchorNode)!==c.getDocument(a))throw new F("WRONG_DOCUMENT_ERR");}function p(b){var a=[],c=new H(b.anchorNode,b.anchorOffset),
d=new H(b.focusNode,b.focusOffset),e="function"==typeof b.getName?b.getName():"Selection";if("undefined"!=typeof b.rangeCount)for(var f=0,g=b.rangeCount;f<g;++f)a[f]=D.inspect(b.getRangeAt(f));return"["+e+"(Ranges: "+a.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.requireModules(["DomUtil","DomRange","WrappedRange"]);a.config.checkSelectionRanges=!0;var c=a.dom,q=a.util,D=a.DomRange,x=a.WrappedRange,F=a.DOMException,H=c.DomPosition,B,G,C=a.util.isHostMethod(window,"getSelection"),
J=a.util.isHostObject(document,"selection"),z=J&&(!C||a.config.preferTextRange);z?(B=u,a.isSelectionValid=function(b){b=(b||window).document;var a=b.selection;return"None"!=a.type||c.getDocument(a.createRange().parentElement())==b}):C?(B=v,a.isSelectionValid=function(){return!0}):y.fail("Neither document.selection or window.getSelection() detected.");a.getNativeSelection=B;var C=B(),P=a.createNativeRange(document),K=c.getBody(document),I=q.areHostObjects(C,q.areHostProperties(C,["anchorOffset","focusOffset"]));
a.features.selectionHasAnchorAndFocus=I;var Q=q.isHostMethod(C,"extend");a.features.selectionHasExtend=Q;var S="number"==typeof C.rangeCount;a.features.selectionHasRangeCount=S;var R=!1,T=!0;q.areHostMethods(C,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof C.rangeCount&&a.features.implementsDomRange&&function(){var b=document.createElement("iframe");b.frameBorder=0;b.style.position="absolute";b.style.left="-10000px";K.appendChild(b);var a=c.getIframeDocument(b);a.open();a.write("<html><head></head><body>12</body></html>");
a.close();var d=c.getIframeWindow(b).getSelection(),e=a.documentElement.lastChild.firstChild,a=a.createRange();a.setStart(e,1);a.collapse(!0);d.addRange(a);T=1==d.rangeCount;d.removeAllRanges();var f=a.cloneRange();a.setStart(e,0);f.setEnd(e,2);d.addRange(a);d.addRange(f);R=2==d.rangeCount;a.detach();f.detach();K.removeChild(b)}();a.features.selectionSupportsMultipleRanges=R;a.features.collapsedNonEditableSelectionsSupported=T;var A=!1,k;K&&q.isHostMethod(K,"createControlRange")&&(k=K.createControlRange(),
q.areHostProperties(k,["item","add"])&&(A=!0));a.features.implementsControlRange=A;G=I?function(b){return b.anchorNode===b.focusNode&&b.anchorOffset===b.focusOffset}:function(b){return b.rangeCount?b.getRangeAt(b.rangeCount-1).collapsed:!1};var L;q.isHostMethod(C,"getRangeAt")?L=function(b,a){try{return b.getRangeAt(a)}catch(c){return null}}:I&&(L=function(b){var d=c.getDocument(b.anchorNode),d=a.createRange(d);d.setStart(b.anchorNode,b.anchorOffset);d.setEnd(b.focusNode,b.focusOffset);d.collapsed!==
this.isCollapsed&&(d.setStart(b.focusNode,b.focusOffset),d.setEnd(b.anchorNode,b.anchorOffset));return d});a.getSelection=function(b){b=b||window;var a=b._rangySelection,c=B(b),d=J?u(b):null;a?(a.nativeSelection=c,a.docSelection=d,a.refresh(b)):(a=new n(c,d,b),b._rangySelection=a);return a};a.getIframeSelection=function(b){return a.getSelection(c.getIframeWindow(b))};k=n.prototype;if(!z&&I&&q.areHostMethods(C,["removeAllRanges","addRange"])){k.removeAllRanges=function(){this.nativeSelection.removeAllRanges();
t(this)};var E=function(b,c){var d=D.getRangeDocument(c),d=a.createRange(d);d.collapseToPoint(c.endContainer,c.endOffset);b.nativeSelection.addRange(w(d));b.nativeSelection.extend(c.startContainer,c.startOffset);b.refresh()};k.addRange=S?function(b,c){if(A&&J&&"Control"==this.docSelection.type)e(this,b);else if(c&&Q)E(this,b);else{var d;R?d=this.rangeCount:(this.removeAllRanges(),d=0);this.nativeSelection.addRange(w(b));this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==d+1?(a.config.checkSelectionRanges&&
(d=L(this.nativeSelection,this.rangeCount-1))&&!D.rangesEqual(d,b)&&(b=new x(d)),this._ranges[this.rangeCount-1]=b,s(this,b,N(this.nativeSelection)),this.isCollapsed=G(this)):this.refresh()}}:function(b,a){a&&Q?E(this,b):(this.nativeSelection.addRange(w(b)),this.refresh())};k.setRanges=function(b){if(A&&1<b.length)r(this,b);else{this.removeAllRanges();for(var a=0,c=b.length;a<c;++a)this.addRange(b[a])}}}else if(q.isHostMethod(C,"empty")&&q.isHostMethod(P,"select")&&A&&z)k.removeAllRanges=function(){try{if(this.docSelection.empty(),
"None"!=this.docSelection.type){var b;if(this.anchorNode)b=c.getDocument(this.anchorNode);else if("Control"==this.docSelection.type){var a=this.docSelection.createRange();a.length&&(b=c.getDocument(a.item(0)).body.createTextRange())}b&&(b.body.createTextRange().select(),this.docSelection.empty())}}catch(d){}t(this)},k.addRange=function(b){"Control"==this.docSelection.type?e(this,b):(x.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,
b,!1))},k.setRanges=function(b){this.removeAllRanges();var a=b.length;1<a?r(this,b):a&&this.addRange(b[0])};else return y.fail("No means of selecting a Range or TextRange was found"),!1;k.getRangeAt=function(b){if(0>b||b>=this.rangeCount)throw new F("INDEX_SIZE_ERR");return this._ranges[b]};var M;if(z)M=function(b){var e;a.isSelectionValid(b.win)?e=b.docSelection.createRange():(e=c.getBody(b.win.document).createTextRange(),e.collapse(!0));"Control"==b.docSelection.type?f(b):e&&"undefined"!=typeof e.text?
d(b,e):t(b)};else if(q.isHostMethod(C,"getRangeAt")&&"number"==typeof C.rangeCount)M=function(b){if(A&&J&&"Control"==b.docSelection.type)f(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;c<d;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));s(b,b._ranges[b.rangeCount-1],N(b.nativeSelection));b.isCollapsed=G(b)}else t(b)};else if(I&&"boolean"==typeof C.isCollapsed&&"boolean"==typeof P.collapsed&&a.features.implementsDomRange)M=
function(b){var a;a=b.nativeSelection;a.anchorNode?(a=L(a,0),b._ranges=[a],b.rangeCount=1,a=b.nativeSelection,b.anchorNode=a.anchorNode,b.anchorOffset=a.anchorOffset,b.focusNode=a.focusNode,b.focusOffset=a.focusOffset,b.isCollapsed=G(b)):t(b)};else return y.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;k.refresh=function(b){var a=b?this._ranges.slice(0):null;M(this);if(b){b=a.length;if(b!=this._ranges.length)return!1;for(;b--;)if(!D.rangesEqual(a[b],this._ranges[b]))return!1;
return!0}};var O=function(b,a){var c=b.getAllRanges(),d=!1;b.removeAllRanges();for(var e=0,f=c.length;e<f;++e)d||a!==c[e]?b.addRange(c[e]):d=!0;b.rangeCount||t(b)};k.removeRange=A?function(b){if("Control"==this.docSelection.type){var a=this.docSelection.createRange();b=g(b);for(var d=c.getDocument(a.item(0)),d=c.getBody(d).createControlRange(),e,k=!1,l=0,n=a.length;l<n;++l)e=a.item(l),e!==b||k?d.add(a.item(l)):k=!0;d.select();f(this)}else O(this,b)}:function(b){O(this,b)};var N;!z&&I&&a.features.implementsDomRange?
(N=function(b){var a=!1;b.anchorNode&&(a=1==c.comparePoints(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset));return a},k.isBackwards=function(){return N(this)}):N=k.isBackwards=function(){return!1};k.toString=function(){for(var b=[],a=0,c=this.rangeCount;a<c;++a)b[a]=""+this._ranges[a];return b.join("")};k.collapse=function(b,d){l(this,b);var e=a.createRange(c.getDocument(b));e.collapseToPoint(b,d);this.removeAllRanges();this.addRange(e);this.isCollapsed=!0};k.collapseToStart=function(){if(this.rangeCount){var b=
this._ranges[0];this.collapse(b.startContainer,b.startOffset)}else throw new F("INVALID_STATE_ERR");};k.collapseToEnd=function(){if(this.rangeCount){var b=this._ranges[this.rangeCount-1];this.collapse(b.endContainer,b.endOffset)}else throw new F("INVALID_STATE_ERR");};k.selectAllChildren=function(b){l(this,b);var d=a.createRange(c.getDocument(b));d.selectNodeContents(b);this.removeAllRanges();this.addRange(d)};k.deleteFromDocument=function(){if(A&&J&&"Control"==this.docSelection.type){for(var b=this.docSelection.createRange(),
a;b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){b=this.getAllRanges();this.removeAllRanges();a=0;for(var c=b.length;a<c;++a)b[a].deleteContents();this.addRange(b[c-1])}};k.getAllRanges=function(){return this._ranges.slice(0)};k.setSingleRange=function(a){this.setRanges([a])};k.containsNode=function(a,c){for(var d=0,e=this._ranges.length;d<e;++d)if(this._ranges[d].containsNode(a,c))return!0;return!1};k.toHtml=function(){var a="";if(this.rangeCount){for(var a=
D.getRangeDocument(this._ranges[0]).createElement("div"),c=0,d=this._ranges.length;c<d;++c)a.appendChild(this._ranges[c].cloneContents());a=a.innerHTML}return a};k.getName=function(){return"WrappedSelection"};k.inspect=function(){return p(this)};k.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null};n.inspect=p;a.Selection=n;a.selectionPrototype=k;a.addCreateMissingNativeApiListener(function(b){"undefined"==typeof b.getSelection&&(b.getSelection=function(){return a.getSelection(this)});
b=null})});
