var Transcriber=function(t){function e(t){return minutes=Math.floor(t/60),minutes=minutes>=10?minutes:"0"+minutes,t=Math.floor(t%60),t=t>=10?t:"0"+t,minutes+":"+t}function a(t){return!isNaN(parseFloat(t))&&isFinite(t)}var i=this,n=!1,r=document.getElementById("audio-player"),o=[],c=!1,u,s,d={debug:!0,participants:["Participant 1","Participant 2"],audio:""},p=t||d;Array.contains=function(t,e){for(var a=t.length;a--;)if(t[a]===e)return!0;return!1},Array.add=function(t,e,a){for(var i=t.length;i--;)if(t[i]===e)return t[e]=a;this.push(e)},Array.prototype.remove=function(t){var e=t;return-1!=e?this.splice(e,1):!1},Storage.prototype.setObject=function(t,e){return this.setItem(t,JSON.stringify(e))},Storage.prototype.getObject=function(t){return JSON.parse(this.getItem(t))},this.init=function(){$("#selectedFile").hide(),$(".open-music").on("click",function(){$("#selectedFile").trigger("click")}),$("#speedSlider").slider({min:.1,max:2,step:.1,value:1,tooltip:"hide"}).on("slide",function(t){a(t.value[0])&&i.adjustPlaySpeed(t.value[0])}),$(".time").html("00:00/"+e(r.duration)),$("#audio-player").bind("timeupdate",function(){var t=e(r.currentTime);$(".time").html(t+"/"+e(r.duration))}),$("#audio-player").bind("durationchange",function(){var t=e(r.currentTime);$(".time").html(t+"/"+e(r.duration))}),$.each(p.participants,function(t,e){$(".participant-buttons").append('<button class="btn btn-primary btn-block individual">'+e+"</button>"),$(".radio").append('<label><input type="radio" name="participantRadio" value="'+e+'">'+e+"</label>")}),$(".participant-buttons").append('<div class="checkbox"><label><input type="checkbox" checked>Automatically switch</label></div>'),$("input:radio:first").prop("checked",!0),$(".individual:first").addClass("active-individual"),$(".list-group").sortable({cancel:":input,button,[contenteditable]",handle:".drag-handle"});var t=$("footer").outerHeight(),c=$("nav").outerHeight()+15;$("body").css({marginBottom:t,marginTop:c}),$(document).on("keydown",function(t){8!==t.which||$(t.target).is("input, textarea, div")||t.preventDefault(),9==t.which&&(t.preventDefault(),i.toggleParticipant()),32==t.which&&t.shiftKey&&(t.preventDefault(),t.stopImmediatePropagation(),i.togglePlay())}),$(document.body).on("click",".list-group-item",function(){var t=$(this).data("index"),e=o[t]?o[t].startTime:0;i.seekTo(e)}),$(document).on("keypress",function(t){60==t.which&&(t.preventDefault(),t.stopImmediatePropagation(),i.Rewind()),62==t.which&&(t.preventDefault(),t.stopImmediatePropagation(),i.Forward())}),$(document.body).on("keypress",".utterance",function(){13==event.which&&(event.preventDefault(),i.updateUtterance($(this).parent().data("index")),$(".current-utterance").focus())}),$(document.body).on("click",".participant-heading",function(){$(this).html($(this).html()==p.participants[0]?p.participants[1]:p.participants[0]),i.updateUtterance($(this).parent().data("index")),$(".current-utterance").focus()}),$(document.body).on("click",".remove-utterance",function(){i.removeUtterance($(this).parent().data("index")),$(".current-utterance").focus()}),$(document.body).on("mouseenter",".list-group-item",function(){$(this).children(".remove-utterance").stop().transition({opacity:1},800,"ease")}),$(document.body).on("mouseleave",".list-group-item",function(){$(this).children(".remove-utterance").stop().transition({opacity:0},500,"ease")}),$(".current-utterance").keypress(function(t){13==t.which&&(t.preventDefault(),t.stopImmediatePropagation(),$("form").submit())}).focus(),$("form").on("submit",function(t){t.preventDefault(),t.stopImmediatePropagation();var e={};e.participant={},e.participant=$("input[name=participantRadio]:checked").val(),e.utterance={},e.utterance=$(".current-utterance").val(),e.startTime={},u=u||0,e.startTime=u,e.submitTime={},e.submitTime=r.currentTime,i.addUtterance(e),u=r.currentTime,$(".current-utterance").val(""),i.toggleParticipant()}),i.loadData(),n=!0},this.saveData=function(){console.log("Saving.");var t=i.getInterviewData();localStorage.setObject("data",t)},this.setData=function(t){o=t},this.loadData=function(){loadedData=localStorage.getObject("data")||{},i.resetInterview(),$.each(loadedData,function(t,e){var a={};a.participant={},a.participant=loadedData[t].participant,a.utterance={},a.utterance=loadedData[t].utterance,a.startTime={},a.startTime=loadedData[t].startTime,a.submitTime={},a.submitTime=loadedData[t].submitTime,i.addUtterance(a)})},this.downloadData=function(){var t="interview.json",e=JSON.stringify(i.getInterviewData(),void 0,2),a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),a.setAttribute("download",t),a.click()},this.toggleParticipant=function(){$('input[type="radio"]').not(":checked").prop("checked",!0),$(".individual").toggleClass("active-individual")},this.getInterviewData=function(){return o},this.resetInterview=function(){currentTime=0,o=[],u=0,i.Stop(),r.src=null,$(".time").html("00:00/00:00"),$(".list-group").empty(),$(".current-utterance").focus(),i.saveData()},this.addUtterance=function(t){o.push(t);var a=o.length-1,n=$('<a class="list-group-item" style="opacity:0;position:relative;top:200px" data-index="'+a+'">').html('<div class="drag-handle" style="background:#eee;height:45px;width:15px;float:left;margin-right:10px;cursor:move"></div><h4 class="list-group-item-heading participant-heading">'+t.participant+'</h4> <h5 contenteditable class="utterance-time">'+e(t.startTime)+"-"+e(t.submitTime)+'</h5><button type="button" class="btn btn-link btn-lg remove-utterance"><span class="glyphicon glyphicon-remove-circle"></span></button><div contenteditable class="utterance">'+t.utterance+"</div></a>");$(".list-group").append(n),n.transition({opacity:1,top:0,background:"rgb(255, 249, 182)"},800,"ease"),$("body, html").stop().animate({scrollTop:n.offset().top},1500),s=setTimeout(function(){n.transition({background:"#fff"},1800,"ease")},1500),i.saveData()},this.updateUtterance=function(t){var e=$('*[data-index="'+t+'"]');o[t].utterance=$(e).children(".utterance").html(),o[t].participant=$(e).children(".participant-heading").html(),i.saveData(),$(e).transition({background:"rgb(232, 255, 235)"},800,"ease"),s=setTimeout(function(){$(e).transition({background:"#ffffff"},1800,"ease")},1500)},this.removeUtterance=function(t){var e=$('*[data-index="'+t+'"]');o.remove(t),s=setTimeout(function(){$(e).transition({background:"Tomato",opacity:0},function(){$(this).remove()})},500),i.saveData()},this.loadAudio=function(t){var a=(window.webkitURL?webkitURL:URL).createObjectURL(t[0]);r.src=a,r.load();var i=e(r.currentTime);$(".current-utterance").focus()},this.togglePlay=function(){c?i.Pause():i.Play()},this.adjustPlaySpeed=function(t){r.playbackRate=t},this.Play=function(){console.log("playing"),r.play(),$(".play span").removeClass("glyphicon-play").addClass("glyphicon-pause"),c=!0},this.Stop=function(){console.log("stopping"),r.pause(),c=!1},this.Pause=function(){r.pause(),$(".play span").removeClass("glyphicon-pause").addClass("glyphicon-play"),c=!1},this.Forward=function(){r.currentTime+=5},this.Rewind=function(){r.currentTime-=5},this.seekTo=function(t){r.readyState>2&&(r.currentTime=t),u=currentTime||t},i.init()};window.onload=function(){window.transcriber=new Transcriber({debug:!0,participants:["Joshua Melville","Martin Farran"],audio:"test.wav"})};